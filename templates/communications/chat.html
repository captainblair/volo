{% extends 'base.html' %}

{% block title %}Chat - Volo Africa{% endblock %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="bg-white rounded-lg shadow-sm border overflow-hidden" style="height: 600px;">
        <div class="flex h-full">
            <!-- Chat Rooms Sidebar -->
            <div class="w-1/4 bg-gray-50 border-r border-gray-200">
                <div class="px-4 py-3 border-b border-gray-200 bg-white">
                    <h3 class="text-lg font-semibold text-gray-900">Chat Rooms</h3>
                </div>
                <div class="overflow-y-auto" style="height: calc(100% - 60px);" x-data="chatData()">
                    <template x-for="room in rooms" :key="room.id">
                        <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100" 
                             :class="{ 'bg-blue-50 border-blue-200': selectedRoom && selectedRoom.id === room.id }"
                             @click="selectRoom(room)">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-400 rounded-full mr-3"></div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900" x-text="room.name"></p>
                                    <p class="text-xs text-gray-500" x-text="room.department || 'General'"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                    <div x-show="rooms.length === 0" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-comments text-2xl mb-2"></i>
                        <p class="text-sm">No chat rooms available</p>
                    </div>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="flex-1 flex flex-col">
                <div class="px-4 py-3 border-b border-gray-200 bg-white">
                    <h3 class="text-lg font-semibold text-gray-900" x-text="selectedRoom ? selectedRoom.name : 'Select a chat room'">Select a chat room</h3>
                </div>
                
                <!-- Messages Container -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50" x-ref="messagesContainer">
                    <div x-show="!selectedRoom" class="text-center text-gray-500 py-8">
                        <i class="fas fa-comment-dots text-4xl mb-4"></i>
                        <p>Select a chat room to start messaging</p>
                    </div>
                    <div x-show="selectedRoom && messages.length === 0" class="text-center text-gray-500 py-8">
                        <i class="fas fa-comment-dots text-4xl mb-4"></i>
                        <p>Start a conversation in this room</p>
                    </div>
                    <div class="space-y-4">
                        <template x-for="message in messages" :key="message.id">
                            <div class="flex items-start space-x-3" :class="message.is_own ? 'flex-row-reverse space-x-reverse' : ''">
                                <img class="w-8 h-8 rounded-full bg-gray-300" 
                                     :src="`https://ui-avatars.com/api/?name=${encodeURIComponent(message.user)}&background=${message.is_own ? '1e40af' : '6b7280'}&color=fff`" 
                                     :alt="message.user">
                                <div class="flex-1" :class="message.is_own ? 'text-right' : ''">
                                    <div class="flex items-center space-x-2" :class="message.is_own ? 'justify-end' : ''">
                                        <span class="text-sm font-medium text-gray-900" x-text="message.user"></span>
                                        <span class="text-xs text-gray-500" x-text="formatTime(message.timestamp)"></span>
                                    </div>
                                    <div class="mt-1">
                                        <p class="text-sm text-gray-700 rounded-lg px-3 py-2 inline-block" 
                                           :class="message.is_own ? 'bg-blue-100' : 'bg-white border'" 
                                           x-text="message.message"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="border-t border-gray-200 p-4 bg-white">
                    <form @submit.prevent="sendMessage()" class="flex space-x-2">
                        <input type="text" x-model="newMessage" placeholder="Type your message..." 
                               class="flex-1 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                               :disabled="!selectedRoom">
                        <button type="submit" :disabled="!selectedRoom || !newMessage.trim()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function chatData() {
    return {
        rooms: [],
        selectedRoom: null,
        messages: [],
        newMessage: '',
        init() {
            this.loadRooms();
        },
        async loadRooms() {
            try {
                const response = await fetch('/communications/api/chat-rooms/');
                if (response.ok) {
                    this.rooms = await response.json();
                } else {
                    console.error('Failed to load chat rooms:', response.status);
                }
            } catch (error) {
                console.error('Error loading chat rooms:', error);
            }
        },
        selectRoom(room) {
            this.selectedRoom = room;
            this.messages = [];
            this.loadRoomMessages(room.id);
        },
        async loadRoomMessages(roomId) {
            try {
                const response = await fetch(`/communications/api/chat-rooms/${roomId}/messages/`);
                if (response.ok) {
                    const data = await response.json();
                    this.messages = data.map(msg => ({
                        ...msg,
                        is_own: msg.user === '{{ user.username }}'
                    }));
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                } else {
                    console.error('Failed to load messages:', response.status);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        },
        async sendMessage() {
            if (!this.selectedRoom || !this.newMessage.trim()) return;
            
            const messageText = this.newMessage.trim();
            this.newMessage = '';
            
            try {
                const response = await fetch(`/communications/api/chat-rooms/${this.selectedRoom.id}/send/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ message: messageText })
                });
                
                if (response.ok) {
                    const newMessage = await response.json();
                    newMessage.is_own = true;
                    this.messages.push(newMessage);
                    this.$nextTick(() => {
                        this.scrollToBottom();
                    });
                } else {
                    console.error('Failed to send message:', response.status);
                    this.newMessage = messageText; // Restore message if failed
                }
            } catch (error) {
                console.error('Error sending message:', error);
                this.newMessage = messageText; // Restore message if failed
            }
        },
        formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        scrollToBottom() {
            const container = this.$refs.messagesContainer;
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
    }
}
</script>
{% endblock %}
